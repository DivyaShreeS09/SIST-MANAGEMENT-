<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OD - HOD</title>
  <link rel="stylesheet" href="./css/theme.css"/>
  <script src="./js/app.js"></script>
  <script src="./js/common.js"></script>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <img src="./assets/logo.png" alt="Logo">
      <div class="title">
        <b>SIST MANAGEMENT SYSTEM</b>
        <span>OD Approval - HOD</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-ghost" data-theme-toggle onclick="toggleTheme()">Dark mode</button>
      <span class="pill">HOD | Department</span>
      <button class="btn btn-primary" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <div style="height:16px"></div>

  <div class="card">
    <h2>OD Approval Dashboard</h2>

    <div class="grid-2">
      <div>
        <label>Filter by Program</label>
        <input id="fProgram" placeholder="e.g., B.E CSE AIML">
      </div>
      <div>
        <label>Filter by Section</label>
        <input id="fSection" placeholder="e.g., A1/A2">
      </div>
    </div>
    <div class="form-row">
      <div>
        <label>Filter by Year</label>
        <input id="fYear" placeholder="e.g., 3">
      </div>
      <div style="display:flex; gap:10px; align-items:flex-end;">
        <button class="btn btn-ghost" id="applyBtn" type="button">Apply</button>
        <button class="btn btn-primary" id="exportBtn" type="button">Export Approved List (PDF)</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Reg No</th>
            <th>Name</th>
            <th>Program</th>
            <th>Section</th>
            <th>Reason</th>
            <th>From</th>
            <th>To</th>
            <th>Proof</th>
            <th>CC</th>
            <th>YC</th>
            <th>CC/YC</th>
            <th>HOD</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const user = requireAuth();
  updateThemeButtonText();
  if(user.role !== "HOD"){ alert("Unauthorized"); location.href="login.html"; }

  function matchesFilters(r){
    const yp = fProgram.value.trim().toLowerCase();
    const ys = fSection.value.trim().toLowerCase();
    const yy = fYear.value.trim();

    const okP = !yp || (r.program||"").toLowerCase().includes(yp);
    const okS = !ys || (r.section||"").toLowerCase().includes(ys);
    const okY = !yy || String(r.year) === String(yy);
    return okP && okS && okY;
  }

  function render(){
    const users = DB.users();
    let list = DB.od();

    list = list.filter(r=>{
      const stu = users.find(x=>x.id===r.studentId);
      return stu && visibleToApprover(user, stu);
    }).filter(matchesFilters);

    body.innerHTML = list.length ? list.map(r=>{
      const ccyc = deriveCCYC(r);
      const canAct = (ccyc==="APPROVED" && r.statusHOD==="PENDING");
      const actionHtml = canAct
        ? `<button class="btn btn-success" onclick="act('${r.id}','APPROVED')">Approve</button>
           <button class="btn btn-danger" onclick="act('${r.id}','REJECTED')">Reject</button>`
        : `<span class="small">${ccyc==="REJECTED" ? "CC/YC rejected" : "Waiting for CC/YC"}</span>`;

      return `
        <tr>
          <td>${r.regNo}</td>
          <td>${r.studentName}</td>
          <td>${r.program}</td>
          <td>${r.section}</td>
          <td>${r.reason}</td>
          <td>${formatDT(r.fromDate,r.fromTime)}</td>
          <td>${formatDT(r.toDate,r.toTime)}</td>
          <td>${r.proofName || "-"}</td>
          <td>${badge(r.statusCC)}</td>
          <td>${badge(r.statusYC)}</td>
          <td>${badge(ccyc)}</td>
          <td>${badge(r.statusHOD)}</td>
          <td style="display:flex; gap:8px; flex-wrap:wrap;">${actionHtml}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="13">No requests found.</td></tr>`;
  }

  function act(id, status){
    const list = DB.od();
    const r = list.find(x=>x.id===id);
    if(!r) return;

    r.statusHOD = status;
    r.hodBy = user.id;
    r.timeline = r.timeline || [];
    r.timeline.unshift({at:new Date().toISOString(), by:user.name, action:`HOD_${status}`});

    DB.saveOD(list);
    render();

    if(status==="APPROVED") alert("Final approval done. Student can download approval letter PDF.");
  }

  applyBtn.onclick = render;

  exportBtn.onclick = ()=>{
    exportApprovedOD(user, {
      year: fYear.value.trim(),
      program: fProgram.value.trim(),
      section: fSection.value.trim()
    });
  };

  render();
</script>
</body>
</html>
