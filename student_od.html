<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>OD Request - Student</title>
  <link rel="stylesheet" href="./css/theme.css"/>
  <script src="./js/app.js"></script>
  <script src="./js/common.js"></script>
</head>
<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <img src="./assets/logo.png" alt="Logo">
      <div class="title">
        <b>SIST MANAGEMENT SYSTEM</b>
        <span>OD Request</span>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn-ghost" data-theme-toggle onclick="toggleTheme()">Dark mode</button>
      <span class="pill" id="who"></span>
      <button class="btn btn-ghost" onclick="location.href='student_dashboard.html'">Dashboard</button>
      <button class="btn btn-primary" onclick="signOut()">Sign Out</button>
    </div>
  </div>

  <div style="height:16px"></div>

  <div class="card">
    <h2>OD Request</h2>
    <form id="odForm">
      <div class="grid-2">
        <div>
          <label>Register No</label>
          <input id="regNo" required>
        </div>
        <div>
          <label>Name</label>
          <input id="name" required>
        </div>
        <div>
          <label>Program</label>
          <input id="program" required>
        </div>
        <div>
          <label>Section</label>
          <input id="section" required>
        </div>
      </div>

      <label>Reason / Subject</label>
      <textarea id="reason" required placeholder="e.g., workshop / Technical Event / Hackathon"></textarea>

      <div class="form-row">
        <div>
          <label>From Date</label>
          <input type="date" id="fromDate" required>
        </div>
        <div>
          <label>To Date</label>
          <input type="date" id="toDate" required>
        </div>
      </div>
      <div class="form-row">
        <div>
          <label>From Time</label>
          <input type="time" id="fromTime" required>
        </div>
        <div>
          <label>To Time</label>
          <input type="time" id="toTime" required>
        </div>
      </div>

      <label>Upload Proof (Letter / Invite / Approval)</label>
      <input type="file" id="proof" required>

      <div style="margin-top:14px;">
        <button class="btn btn-primary" style="width:100%;">Submit OD Request</button>
      </div>
    </form>

    <div class="hr"></div>

    <h2>Your OD History</h2>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Reason</th>
            <th>From</th>
            <th>To</th>
            <th>CC</th>
            <th>YC</th>
            <th>HOD</th>
            <th>PDF</th>
          </tr>
        </thead>
        <tbody id="odBody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const u = requireAuth();
  updateThemeButtonText();
  document.getElementById("who").textContent = `Logged in: ${u.name}`;

  // Autofill but still required (user can edit if needed)
  regNo.value = u.username;
  name.value = u.name;
  program.value = u.program;
  section.value = u.section;

  function render(){
    const list = DB.od().filter(r=>r.studentId===u.id);
    odBody.innerHTML = list.length ? list.map(r=>{
      const finalOk = deriveCCYC(r)==="APPROVED" && (r.statusHOD||"") === "APPROVED";
      return `
        <tr>
          <td>${r.reason}</td>
          <td>${formatDT(r.fromDate,r.fromTime)}</td>
          <td>${formatDT(r.toDate,r.toTime)}</td>
          <td>${badge(r.statusCC)}</td>
          <td>${badge(r.statusYC)}</td>
          <td>${badge(r.statusHOD)}</td>
          <td>${finalOk ? `<button class="btn btn-ghost" onclick="downloadODLetter(${JSON.stringify(r).replaceAll('"','&quot;')})">Download</button>` : `<span class="small">â€”</span>`}</td>
        </tr>
      `;
    }).join("") : `<tr><td colspan="7">No OD requests yet.</td></tr>`;
  }
  render();

  odForm.addEventListener("submit",(e)=>{
    e.preventDefault();

    const f = proof.files[0];
    if(!f) return alert("Proof file is required.");

    const od = DB.od();
    const id = "od" + (Date.now());
    od.unshift({
      id, studentId: u.id,
      regNo: regNo.value.trim(),
      studentName: name.value.trim(),
      program: program.value.trim(),
      section: section.value.trim(),
      year: u.year, dept: u.dept,
      reason: reason.value.trim(),
      fromDate: fromDate.value, toDate: toDate.value,
      fromTime: fromTime.value, toTime: toTime.value,
      proofName: f.name,

      statusCC:"PENDING", ccBy:null,
      statusYC:"PENDING", ycBy:null,
      statusHOD:"PENDING", hodBy:null,
      timeline:[{at:new Date().toISOString(), by:u.name, action:"CREATED"}]
    });

    DB.saveOD(od);
    odForm.reset();

    regNo.value = u.username; name.value=u.name; program.value=u.program; section.value=u.section;
    render();
    alert("OD request submitted.");
  });
</script>
</body>
</html>
